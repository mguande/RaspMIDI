<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RaspMIDI - Palco</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        body { 
            background: #181c24; 
            color: #fff; 
            font-family: 'Segoe UI', Arial, sans-serif; 
            margin: 0;
            padding: 0;
            font-size: 14px;
        }
        
        .palco-container { 
            max-width: 100%; 
            margin: 0 auto; 
            padding: 10px; 
            position: relative;
        }
        
        .back-btn {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: #2a2e3a;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 3rem;
            height: 3rem;
            font-size: 1.5rem;
            cursor: pointer;
            transition: background 0.2s;
            z-index: 10;
        }
        
        .back-btn:hover {
            background: #3a3e4a;
        }
        
        .palco-title {
            text-align: center;
            margin-bottom: 2rem;
            color: #fff;
            border: 2px solid #333;
            border-radius: 1rem;
            padding: 1.5rem;
            background: #1a1e2a;
            position: relative;
        }
        
        .palco-title .bank-name {
            font-size: 2rem;
            color: #ffd700;
            margin: 0;
            font-weight: bold;
            text-shadow: 0 0 10px #ffd700;
        }
        
        .palco-title h1 {
            font-size: 2rem;
            margin: 0;
            color: #fff;
        }
        
        .palco-title .bank-name {
            font-size: 1.2rem;
            color: #ccc;
            margin-top: 0.5rem;
        }
        
        .no-patch-message {
            background: #3a2e2e;
            border: 1px solid #a55;
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1rem 0;
            text-align: center;
            color: #faa;
            font-weight: bold;
        }
        
        .active-bank-info {
            background: #23283a;
            border-radius: 0.8rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
            border: 2px solid #ffb300;
        }
        
        .active-bank-name {
            font-size: 1.8rem;
            font-weight: bold;
            color: #ffb300;
            margin-bottom: 0.5rem;
        }
        
        .active-bank-description {
            font-size: 0.9rem;
            color: #ccc;
        }
        
        .active-patch-info {
            background: #1a1e2a;
            border-radius: 0.8rem;
            padding: 1rem;
            margin-bottom: 1rem;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            border: 1px solid #333;
        }
        
        .active-patch-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #0f0;
            margin-bottom: 0.5rem;
        }
        
        .active-patch-details {
            font-size: 0.8rem;
            color: #ccc;
        }
        
        .no-active-patch {
            text-align: center;
            color: #888;
            font-style: italic;
            padding: 1rem;
            font-size: 0.9rem;
        }
        
        .devices-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .device-box { 
            background: #1a1e2a; 
            border-radius: 0.8rem; 
            padding: 1rem; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            border: 1px solid #333;
            transition: all 0.3s;
        }
        
        .device-box:hover {
            border-color: #ffb300;
        }
        
        .device-header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.8rem;
            gap: 0.5rem;
        }
        
        .device-title { 
            font-size: 1.1rem; 
            font-weight: bold; 
            color: #ffb300;
        }
        
        .connection-icon {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid;
        }
        
        .connection-icon.connected {
            background: #0f0;
            border-color: #0f0;
        }
        
        .connection-icon.disconnected {
            background: #f33;
            border-color: #f33;
        }
        
        .device-info {
            margin-bottom: 0.8rem;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.3rem 0;
            border-bottom: 1px solid #333;
            font-size: 0.8rem;
        }
        
        .info-label {
            font-weight: bold;
            color: #ccc;
        }
        
        .info-value {
            color: #ffb300;
            font-weight: bold;
        }
        
        .reconnect-btn { 
            margin-top: 0.8rem; 
            background: #ff6b35; 
            color: #fff; 
            border: none; 
            border-radius: 0.3rem; 
            padding: 0.5rem 1rem; 
            font-size: 0.8rem; 
            font-weight: bold; 
            cursor: pointer; 
            transition: background 0.2s;
            width: 100%;
        }
        
        .reconnect-btn:hover { 
            background: #e55a2b; 
        }
        
        .reconnect-btn:disabled { 
            background: #666; 
            cursor: not-allowed; 
        }
        
        .midi-status {
            background: #2a2e3a;
            border-radius: 0.5rem;
            padding: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.7rem;
            text-align: center;
            color: #ccc;
        }
        
        .midi-status.active {
            background: #1a3a1a;
            color: #0f0;
            border: 1px solid #0f0;
        }
        
        .chocolate-box {
            background: #1a1e2a;
            border: 2px solid #333;
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            min-height: 200px;
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .chocolate-pedal-visual {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-grow: 1;
        }
        
        .chocolate-leds {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .chocolate-led {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #555;
            background: #333;
            transition: all 0.3s ease;
        }
        
        .chocolate-led.on {
            background: #0f0;
            box-shadow: 0 0 15px #0f0;
            border-color: #0f0;
        }
        
        .chocolate-led.off {
            background: #333;
            border-color: #555;
        }
        
        .chocolate-display-wrapper {
            background: #000;
            border: 2px solid #333;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            margin: 0 1rem;
            min-width: 80px;
        }
        
        .chocolate-display {
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            font-weight: bold;
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
        }
        
        .chocolate-display.off {
            color: #f00;
            text-shadow: 0 0 5px #f00;
        }
        
        .chocolate-connect-btn {
            background: #2a5a2a;
            color: #fff;
            border: none;
            border-radius: 0.3rem;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 0.5rem;
            width: 100%;
        }
        
        .chocolate-connect-btn:hover {
            background: #3a7a3a;
        }
        
        .chocolate-connect-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .zoom-display-wrapper {
            background: #000;
            border: 2px solid #333;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            margin: 0 1rem;
            min-width: 120px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .zoom-display {
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            font-weight: bold;
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
        }
        
        .zoom-display.off {
            color: #f00;
            text-shadow: 0 0 5px #f00;
        }
    </style>
</head>
<body>
    <div class="palco-container">
        <button class="back-btn" onclick="window.location.href='/'">←</button>
        
        <div class="palco-title">
            <div class="bank-name" id="bank-name">Nenhum Banco Ativo</div>
        </div>
        
        <div class="devices-grid" id="devices-grid">
            <!-- Dispositivos serão renderizados aqui dinamicamente -->
        </div>
    </div>
    
    <script>
        let activePatch = null;
        let activeBank = null;
        let midiMonitoringActive = false;
        let lastActiveBankId = null; // Para controlar mudanças no banco ativo
        let isInitialLoad = true; // Para controlar o carregamento inicial
        
        async function loadPalcoInfo() {
            try {
                // Carrega informações do banco ativo
                const bankChanged = await loadActiveBankInfo();
                
                // Na primeira execução ou se o banco ativo mudou, carrega tudo
                if (isInitialLoad || bankChanged) {
                    console.log(isInitialLoad ? '🚀 Carregamento inicial...' : '🔄 Banco ativo mudou, recarregando informações...');
                    
                    // Carrega informações do patch ativo
                    await loadActivePatchInfo();
                    
                    // Carrega dispositivos (sempre na primeira execução)
                    await loadDevicesInfo();
                    
                    // Inicia monitoramento MIDI se não estiver ativo
                    if (!midiMonitoringActive) {
                        await startMidiMonitoring();
                    }
                    
                    // Marca que não é mais o carregamento inicial
                    isInitialLoad = false;
                } else {
                    // Se o banco não mudou, só atualiza o patch ativo (pode ter mudado por MIDI)
                    await loadActivePatchInfo();
                }
                
            } catch (error) {
                console.error('Erro ao carregar informações do palco:', error);
            }
        }
        
        async function loadActiveBankInfo() {
            try {
                const response = await fetch('/api/midi/banks/active');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const newBank = data.data;
                    const newBankId = newBank.id;
                    
                    // Verifica se o banco ativo mudou
                    if (lastActiveBankId !== newBankId) {
                        console.log(`🔄 Banco ativo mudou: ${lastActiveBankId} -> ${newBankId}`);
                        activeBank = newBank;
                        lastActiveBankId = newBankId;
                        showActiveBank(activeBank);
                        return true; // Indica que o banco mudou
                    } else {
                        // Banco não mudou
                        return false;
                    }
                } else {
                    // Se não há banco ativo
                    if (lastActiveBankId !== null) {
                        console.log('🔄 Banco ativo removido');
                        lastActiveBankId = null;
                        hideActiveBank();
                        return true; // Indica mudança (banco foi removido)
                    } else {
                        hideActiveBank();
                        return false; // Não mudou
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar banco ativo:', error);
                hideActiveBank();
                return false;
            }
        }
        
        function showActiveBank(bank) {
            document.getElementById('bank-name').textContent = bank.name;
        }
        
        function hideActiveBank() {
            document.getElementById('bank-name').textContent = 'Nenhum Banco Ativo';
        }
        
        async function loadActivePatchInfo() {
            try {
                const response = await fetch('/api/patches/active');
                const data = await response.json();
                
                if (data.success && data.data && data.data.active_patch) {
                    activePatch = data.data.active_patch;
                    
                    // Restaura o nome do banco no título
                    if (activeBank) {
                        document.getElementById('bank-name').textContent = activeBank.name;
                    }
                    
                    // Atualiza o visual do Chocolate se o patch ativo for do Chocolate
                    if (activePatch.input_device === 'Chocolate MIDI' && activePatch.input_channel !== undefined) {
                        const bankNumber = parseInt(activePatch.input_channel);
                        // Busca o status de conexão do Chocolate
                        const devicesResponse = await fetch('/api/midi/devices/status_detailed');
                        const devicesData = await devicesResponse.json();
                        if (devicesData.success) {
                            const chocolateDevice = devicesData.data.find(dev => dev.type === 'chocolate');
                            if (chocolateDevice) {
                                renderChocolatePedal(bankNumber, chocolateDevice.connected);
                            }
                        }
                    }
                    
                    // Atualiza o display do Zoom se o patch tiver configuração da Zoom
                    if (activePatch.zoom_bank !== undefined && activePatch.zoom_patch !== undefined) {
                        // Busca o status de conexão da Zoom
                        const devicesResponse = await fetch('/api/midi/devices/status_detailed');
                        const devicesData = await devicesResponse.json();
                        if (devicesData.success) {
                            const zoomDevice = devicesData.data.find(dev => dev.type === 'zoom_g3x');
                            if (zoomDevice) {
                                // Usa zoom_bank_letter se disponível, senão zoom_bank
                                const bankToShow = activePatch.zoom_bank_letter || activePatch.zoom_bank;
                                updateZoomDisplay(bankToShow, activePatch.zoom_patch, zoomDevice.connected);
                            }
                        }
                    }
                } else {
                    // Não sobrescreve ou esconde o patch ativo se a resposta for vazia ou erro
                    if (activePatch) {
                        // Restaura o nome do banco no título se há patch ativo
                        if (activeBank) {
                            document.getElementById('bank-name').textContent = activeBank.name;
                        }
                    } // não chama hideActivePatch
                }
            } catch (error) {
                console.error('Erro ao carregar patch ativo:', error);
                // Não esconde o patch ativo em caso de erro
                if (activePatch) {
                    // Restaura o nome do banco no título se há patch ativo
                    if (activeBank) {
                        document.getElementById('bank-name').textContent = activeBank.name;
                    }
                } // não chama hideActivePatch
            }
        }
        
        function hideActivePatch() {
            // Mostra a mensagem no título
            document.getElementById('bank-name').textContent = 'Não existe patch para este banco';
        }
        
        async function loadDevicesInfo() {
            try {
                const response = await fetch('/api/midi/devices/status_detailed');
                const data = await response.json();
                
                const grid = document.getElementById('devices-grid');
                grid.innerHTML = '';
                
                if (data.success && Array.isArray(data.data)) {
                    data.data.forEach(dev => {
                        if (dev.type === 'chocolate') {
                            // Para o Chocolate, usa o visual do pedal
                            const box = createChocolatePedalBox(dev);
                            grid.appendChild(box);
                        } else {
                            // Para outros dispositivos, usa o box padrão
                            const box = createDeviceBox(dev);
                            grid.appendChild(box);
                        }
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar dispositivos:', error);
            }
        }
        
        function createDeviceBox(dev) {
            const box = document.createElement('div');
            box.className = 'device-box';
            
            const connectionClass = dev.connected ? 'connected' : 'disconnected';
            
            let zoomDisplay = '';
            
            if (dev.type === 'zoom_g3x') {
                // Para Zoom G3X: apenas display, título e bullet de conexão
                const bank = dev.bank || '-';
                const patch = dev.last_pc !== null && dev.last_pc !== undefined ? dev.last_pc : '-';
                
                // Cria o texto do display: "Banco [Letra] - [Número]"
                let displayText = '---';
                if (dev.connected && bank !== '-' && patch !== '-') {
                    // Converte número do banco para letra (0=A, 1=B, 2=C, etc.)
                    const bankLetter = String.fromCharCode(65 + parseInt(bank)); // A=65, B=66, etc.
                    displayText = `Banco ${bankLetter} - ${patch}`;
                }
                
                zoomDisplay = `
                    <div class="zoom-display-wrapper">
                        <span class="zoom-display ${dev.connected ? '' : 'off'}" id="zoom-display">${displayText}</span>
                    </div>
                `;
            }
            
            box.innerHTML = `
                <div class="device-header">
                    <div class="connection-icon ${connectionClass}"></div>
                    <div class="device-title">${dev.name}</div>
                </div>
                ${zoomDisplay}
            `;
            
            return box;
        }
        
        function createChocolatePedalBox(dev) {
            const box = document.createElement('div');
            box.className = 'device-box chocolate-box';
            
            const connectionClass = dev.connected ? 'connected' : 'disconnected';
            
            // Calcula o banco atual baseado no patch ativo
            let currentBank = 0;
            if (activePatch && activePatch.input_device === 'Chocolate MIDI' && activePatch.input_channel !== undefined) {
                currentBank = parseInt(activePatch.input_channel);
            }
            
            // Renderiza o pedal do Chocolate
            renderChocolatePedal(currentBank, dev.connected);
            
            // Botão de conectar (só aparece se desconectado)
            const connectButton = dev.connected ? '' : `
                <button class="chocolate-connect-btn" onclick="connectChocolate()">
                    🔌 Conectar Chocolate MIDI
                </button>
            `;
            
            box.innerHTML = `
                <div class="device-header">
                    <span class="connection-icon ${connectionClass}" id="chocolate-connection-icon"></span>
                    <span class="device-title">Chocolate MIDI</span>
                </div>
                <div class="chocolate-pedal-visual">
                    <div class="chocolate-leds">
                        <div class="chocolate-led" id="led-0"></div>
                        <div class="chocolate-led" id="led-1"></div>
                    </div>
                    <div class="chocolate-display-wrapper">
                        <span class="chocolate-display" id="chocolate-display">000</span>
                    </div>
                    <div class="chocolate-leds">
                        <div class="chocolate-led" id="led-2"></div>
                        <div class="chocolate-led" id="led-3"></div>
                    </div>
                </div>
                ${connectButton}
            `;
            
            return box;
        }
        
        function renderChocolatePedal(bankNumber, connected) {
            if (connected) {
                // Se conectado, atualiza o display com o banco atual
                updateChocolateDisplay(bankNumber);
            } else {
                // Se desconectado, mostra OFF
                const display = document.getElementById('chocolate-display');
                if (display) {
                    display.textContent = 'OFF';
                    display.classList.add('off');
                }
                
                // Desliga todos os LEDs
                for (let i = 0; i < 4; i++) {
                    const led = document.getElementById('led-' + i);
                    if (led) {
                        led.classList.remove('on');
                        led.classList.add('off');
                    }
                }
            }
            
            // Atualiza ícone de conexão
            const icon = document.getElementById('chocolate-connection-icon');
            if (icon) {
                icon.classList.toggle('connected', connected);
                icon.classList.toggle('disconnected', !connected);
            }
        }
        
        function updateZoomDisplay(bank, patch, connected) {
            const display = document.getElementById('zoom-display');
            if (display) {
                let displayText = '---';
                if (connected && bank !== '-' && patch !== '-') {
                    // Usa a letra do banco se disponível, senão converte o número
                    let bankLetter = bank;
                    if (typeof bank === 'number' || (typeof bank === 'string' && !isNaN(bank))) {
                        // Converte número do banco para letra (0=A, 1=B, 2=C, etc.)
                        bankLetter = String.fromCharCode(65 + parseInt(bank)); // A=65, B=66, etc.
                    }
                    displayText = `Banco ${bankLetter} - ${patch}`;
                }
                
                display.textContent = displayText;
                display.classList.toggle('off', !connected);
            }
        }
        
        async function startMidiMonitoring() {
            try {
                console.log('🎹 Iniciando monitoramento MIDI...');
                
                const response = await fetch('/api/midi/monitor/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        device: 'Chocolate MIDI In'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    midiMonitoringActive = true;
                    console.log('✅ Monitoramento MIDI iniciado');
                    
                    // Inicia polling para verificar comandos MIDI
                    startMidiPolling();
                } else {
                    console.error('❌ Erro ao iniciar monitoramento MIDI:', data.error);
                }
                
            } catch (error) {
                console.error('❌ Erro ao iniciar monitoramento MIDI:', error);
            }
        }
        
        function startMidiPolling() {
            // Verifica comandos MIDI a cada 500ms
            setInterval(async () => {
                if (!midiMonitoringActive) return;
                
                try {
                    const response = await fetch('/api/midi/commands/received');
                    const data = await response.json();
                    
                    if (data.success && data.commands && data.commands.length > 0) {
                        // Processa novos comandos MIDI
                        data.commands.forEach(command => {
                            processMidiCommand(command);
                        });
                    }
                } catch (error) {
                    console.error('Erro ao verificar comandos MIDI:', error);
                }
            }, 500);
        }
        
        function processMidiCommand(command) {
            console.log('🎹 Comando MIDI recebido:', command);
            // Se for um Program Change do Chocolate, busca e ativa o patch correspondente
            if (command.type === 'program_change' && command.program !== undefined) {
                console.log(`🎹 Program Change detectado: ${command.program}`);
                
                // SEMPRE atualiza o display do Chocolate com o banco selecionado
                updateChocolateDisplay(command.program);
                
                // Busca e ativa o patch correspondente
                findAndActivatePatchByProgram(command.program);
            }
        }
        
        function updateChocolateDisplay(program) {
            // Atualiza o display do Chocolate para mostrar o banco selecionado
            const display = document.getElementById('chocolate-display');
            if (display) {
                display.textContent = ('' + program).padStart(3, '0');
                display.classList.remove('off');
            }
            
            // Atualiza os LEDs do Chocolate
            const ledIndex = program % 4;
            for (let i = 0; i < 4; i++) {
                const led = document.getElementById('led-' + i);
                if (led) {
                    if (i === ledIndex) {
                        led.classList.add('on');
                        led.classList.remove('off');
                    } else {
                        led.classList.remove('on');
                        led.classList.add('off');
                    }
                }
            }
        }
        
        async function findAndActivatePatchByProgram(program) {
            try {
                console.log(`🔍 Procurando patch com program ${program}...`);
                
                const response = await fetch('/api/patches');
                const data = await response.json();
                
                if (data.success && data.data) {
                    console.log(`📋 Total de patches encontrados: ${data.data.length}`);
                    
                    // Log de todos os patches do Chocolate para debug
                    const allChocolatePatches = data.data.filter(patch => patch.input_device === 'Chocolate MIDI');
                    console.log(`🎹 Patches do Chocolate encontrados: ${allChocolatePatches.length}`);
                    
                    allChocolatePatches.forEach((patch, index) => {
                        console.log(`   Patch ${index + 1}:`, {
                            name: patch.name,
                            program: patch.program,
                            input_channel: patch.input_channel,
                            id: patch.id
                        });
                    });
                    
                    const chocolatePatches = data.data.filter(patch => 
                        patch.input_device === 'Chocolate MIDI' && 
                        patch.program === program
                    );
                    
                    console.log(`🎯 Patches com program ${program}: ${chocolatePatches.length}`);
                    
                    if (chocolatePatches.length > 0) {
                        const patch = chocolatePatches[0];
                        console.log(`✅ Patch encontrado: ${patch.name}`);
                        
                        // Restaura o nome do banco no título
                        if (activeBank) {
                            document.getElementById('bank-name').textContent = activeBank.name;
                        }
                        
                        // Ativa o patch no sistema (isso já envia para a Zoom se necessário)
                        await activatePatch(patch);
                    } else {
                        console.log(`❌ Nenhum patch encontrado para program ${program}`);
                        
                        // Tenta buscar por input_channel também
                        const patchesByChannel = data.data.filter(patch => 
                            patch.input_device === 'Chocolate MIDI' && 
                            patch.input_channel === program
                        );
                        
                        console.log(`🔍 Tentativa por input_channel ${program}: ${patchesByChannel.length} patches`);
                        
                        if (patchesByChannel.length > 0) {
                            console.log(`✅ Patch encontrado por input_channel: ${patchesByChannel[0].name}`);
                            const patch = patchesByChannel[0];
                            
                            // Restaura o nome do banco no título
                            if (activeBank) {
                                document.getElementById('bank-name').textContent = activeBank.name;
                            }
                            
                            // Ativa o patch no sistema (isso já envia para a Zoom se necessário)
                            await activatePatch(patch);
                        } else {
                            // Mostra a mensagem no título
                            document.getElementById('bank-name').textContent = 'Não existe patch para este banco';
                            
                            // Limpa o display da Zoom já que não há patch correspondente
                            updateZoomDisplay('-', '-', false);
                        }
                    }
                } else {
                    console.log(`❌ Erro na resposta da API: ${data.success ? 'success=false' : 'data não encontrado'}`);
                }
            } catch (error) {
                console.error('Erro ao procurar patch por program:', error);
                // Mostra a mensagem no título em caso de erro
                document.getElementById('bank-name').textContent = 'Não existe patch para este banco';
                
                // Limpa o display da Zoom em caso de erro
                updateZoomDisplay('-', '-', false);
            }
        }
        
        async function activatePatch(patch) {
            try {
                console.log(`🎹 Ativando patch: ${patch.name}`);
                
                // Ativa o patch via API
                const response = await fetch('/api/midi/patch/load', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ patch_id: patch.id })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('✅ Patch ativado no sistema');
                    activePatch = patch;
                    
                    // Atualiza o visual do Chocolate se o patch for do Chocolate
                    if (patch.input_device === 'Chocolate MIDI' && patch.input_channel !== undefined) {
                        const bankNumber = parseInt(patch.input_channel);
                        // Busca o status de conexão do Chocolate
                        const devicesResponse = await fetch('/api/midi/devices/status_detailed');
                        const devicesData = await devicesResponse.json();
                        if (devicesData.success) {
                            const chocolateDevice = devicesData.data.find(dev => dev.type === 'chocolate');
                            if (chocolateDevice) {
                                renderChocolatePedal(bankNumber, chocolateDevice.connected);
                            }
                        }
                    }
                    
                    // Atualiza o display do Zoom se o patch tiver configuração da Zoom
                    if (patch.zoom_bank !== undefined && patch.zoom_patch !== undefined) {
                        // Busca o status de conexão da Zoom
                        const devicesResponse = await fetch('/api/midi/devices/status_detailed');
                        const devicesData = await devicesResponse.json();
                        if (devicesData.success) {
                            const zoomDevice = devicesData.data.find(dev => dev.type === 'zoom_g3x');
                            if (zoomDevice) {
                                // Usa zoom_bank_letter se disponível, senão zoom_bank
                                const bankToShow = patch.zoom_bank_letter || patch.zoom_bank;
                                updateZoomDisplay(bankToShow, patch.zoom_patch, zoomDevice.connected);
                            }
                        }
                    }
                } else {
                    console.error('❌ Erro ao ativar patch:', data.error);
                }
            } catch (error) {
                console.error('❌ Erro ao ativar patch:', error);
            }
        }
        
        // Função para reconectar Zoom G3X
        async function reconnectZoomG3X() {
            try {
                const response = await fetch('/api/midi/devices/zoom_g3x/reconnect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('Zoom G3X reconectado com sucesso!');
                    loadPalcoInfo(); // Recarrega as informações
                } else {
                    console.error('Erro ao reconectar Zoom G3X:', data.message || 'Erro desconhecido');
                }
            } catch (error) {
                console.error('Erro ao reconectar Zoom G3X:', error.message);
            }
        }
        
        // Função para reconectar Chocolate
        async function reconnectChocolate() {
            try {
                const response = await fetch('/api/midi/devices/chocolate/reconnect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('Chocolate reconectado com sucesso!');
                    loadPalcoInfo(); // Recarrega as informações
                } else {
                    console.error('Erro ao reconectar Chocolate:', data.message || 'Erro desconhecido');
                }
            } catch (error) {
                console.error('Erro ao reconectar Chocolate:', error.message);
            }
        }
        
        async function connectChocolate() {
            try {
                console.log('🔌 Conectando Chocolate MIDI...');
                
                const response = await fetch('/api/midi/devices/chocolate/reconnect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('✅ Chocolate MIDI conectado');
                    
                    // Recarrega informações dos dispositivos
                    await loadDevicesInfo();
                    
                    // Inicia monitoramento MIDI se não estiver ativo
                    if (!midiMonitoringActive) {
                        await startMidiMonitoring();
                    }
                } else {
                    console.error('❌ Erro ao conectar Chocolate MIDI:', data.error);
                }
                
            } catch (error) {
                console.error('❌ Erro ao conectar Chocolate MIDI:', error);
            }
        }

        // Inicialização
        window.addEventListener('DOMContentLoaded', loadPalcoInfo);
        
        // Atualiza a cada 10 segundos para verificar mudanças no banco ativo
        setInterval(loadPalcoInfo, 10000);
    </script>
</body>
</html> 