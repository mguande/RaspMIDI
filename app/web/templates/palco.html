<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RaspMIDI - Palco</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script>
        // Força refresh do cache
        if (window.performance && window.performance.navigation.type === window.performance.navigation.TYPE_BACK_FORWARD) {
            window.location.reload();
        }
    </script>
    <style>
        body { 
            background: linear-gradient(135deg, #0f1419 0%, #1a1e2a 50%, #0f1419 100%);
            color: #fff; 
            font-family: 'Segoe UI', Arial, sans-serif; 
            margin: 0;
            padding: 0;
            font-size: 14px;
            min-height: 100vh;
        }
        
        .palco-container { 
            max-width: 480px; 
            margin: 0 auto; 
            padding: 10px; 
            position: relative;
            height: 320px;
            overflow: hidden;
        }
        
        /* Botão voltar removido da posição fixa - agora está na caixa de botões */
        
        .palco-header {
            text-align: center;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: linear-gradient(145deg, #1a1e2a, #23283a);
            border-radius: 0.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            border: 1px solid #ffd700;
            position: relative;
            overflow: hidden;
        }
        
        .bank-name {
            font-size: 1.8rem;
            color: #ffd700;
            margin: 0;
            font-weight: bold;
            text-shadow: 0 0 5px #ffd700;
            letter-spacing: 1px;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr min-content;
            gap: 0.5rem;
            margin-top: 0.5rem;
            align-items: stretch;
        }
        
        .device-box, .chocolate-box, .zoom-display {
            min-width: 0;
            width: 100%;
            box-sizing: border-box;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding-top: 0.5rem;
        }
        
        .status-card {
            background: linear-gradient(145deg, #1a1e2a, #23283a);
            border-radius: 0.3rem;
            padding: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .status-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #00ff88, #00ccff);
        }
        
        .buttons-card {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: flex-start;
            justify-content: flex-start;
            min-width: 48px;
            width: 56px;
        }
        
        .action-btn {
            background: linear-gradient(145deg, #2a2e3a, #1a1e2a);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 0.3rem;
            width: 40px;
            height: 40px;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        
        .action-btn:hover {
            background: linear-gradient(145deg, #3a3e4a, #2a2e3a);
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
            border-color: rgba(255,255,255,0.4);
        }
        
        .action-btn.back-btn {
            background: linear-gradient(145deg, #3a2e2e, #2a1e1e);
            border-color: rgba(255,100,100,0.3);
        }
        
        .action-btn.back-btn:hover {
            background: linear-gradient(145deg, #4a3e3e, #3a2e2e);
            border-color: rgba(255,100,100,0.6);
        }
        
        .action-btn.refresh-btn {
            background: linear-gradient(145deg, #2e3a2e, #1e2a1e);
            border-color: rgba(100,255,100,0.3);
        }
        
        .action-btn.refresh-btn:hover {
            background: linear-gradient(145deg, #3e4a3e, #2e3a2e);
            border-color: rgba(100,255,100,0.6);
        }
        
        .action-btn.edit-btn {
            background: linear-gradient(145deg, #2e2e3a, #1e1e2a);
            border-color: rgba(100,100,255,0.3);
        }
        
        .action-btn.edit-btn:hover {
            background: linear-gradient(145deg, #3e3e4a, #2e2e3a);
            border-color: rgba(100,100,255,0.6);
        }
        
        .device-box {
            background: linear-gradient(145deg, #1a1e2a, #23283a);
            border-radius: 0.3rem;
            padding: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
            overflow: hidden;
        }
        .device-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #00ff88, #00ccff 50%, #ffd700 100%);
        }
        .device-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .device-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #fff;
            letter-spacing: 1px;
            text-shadow: 0 0 4px #00ff88, 0 0 2px #ffd700;
        }
        
        .card-title {
            font-size: 0.8rem;
            font-weight: bold;
            color: #ffb300;
            margin-bottom: 0.3rem;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .card-content {
            text-align: center;
        }
        
        .patch-name {
            font-size: 2rem;
            font-weight: bold;
            color: #00ff88;
            margin-bottom: 0.5rem;
            text-shadow: 0 0 10px #00ff88;
        }
        
        .patch-details {
            font-size: 1rem;
            color: #ccc;
            margin-bottom: 1rem;
        }
        
        .device-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid;
            animation: pulse 2s infinite;
        }
        
        .status-indicator.connected {
            background: #00ff88;
            border-color: #00ff88;
            box-shadow: 0 0 10px #00ff88;
        }
        
        .status-indicator.disconnected {
            background: #ff4444;
            border-color: #ff4444;
            box-shadow: 0 0 10px #ff4444;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .device-name {
            font-size: 1.1rem;
            font-weight: bold;
            color: #fff;
        }
        
        .device-info {
            font-size: 0.9rem;
            color: #aaa;
            margin-top: 0.5rem;
        }
        
        .no-patch-message {
            background: linear-gradient(145deg, #3a2e2e, #4a2e2e);
            border: 1px solid #ff6666;
            border-radius: 0.8rem;
            padding: 1.5rem;
            margin: 1rem 0;
            text-align: center;
            color: #ffaaaa;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 4px 15px rgba(255,0,0,0.2);
        }
        
        .displays-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .chocolate-display, .zoom-display {
            /* width: 100%; */
            /* display: flex; */
            /* flex-direction: column; */
            /* align-items: center; */
            text-align: center;
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            font-weight: bold;
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
        }
        
        .chocolate-pedal {
            background: linear-gradient(145deg, #2a2e3a, #1a1e2a);
            border-radius: 0.3rem;
            padding: 0.5rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .chocolate-pedal::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #00ff88, #00ccff);
        }
        
        .pedal-title, .zoom-title {
            font-size: 0.9rem;
            font-weight: bold;
            color: #ffb300;
            margin-bottom: 0.3rem;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .pedal-display {
            /* Removido: width, height, font-family, font-size, cor, etc. */
        }
        
        .pedal-leds, .zoom-effects {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 0.3rem;
            margin-top: 0.2rem;
            margin-bottom: 0.2rem;
        }
        
        .led {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 1px solid #333;
            transition: all 0.3s ease;
        }
        
        .led.on {
            background: #00ff00;
            border-color: #00ff00;
            box-shadow: 0 0 10px #00ff00;
        }
        
        .led.off {
            background: #333;
            border-color: #555;
        }
        
        .zoom-display {
            background: linear-gradient(145deg, #1a1e2a, #23283a);
            border-radius: 0.3rem;
            padding: 0.5rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .zoom-display::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #ff6b35, #ffd700);
        }
        
        .zoom-screen {
            /* Removido: width, height, font-family, font-size, cor, etc. */
        }
        
        .display-screen {
            width: 110px;
            height: 38px;
            background: #000;
            border: 1px solid #333;
            border-radius: 0.2rem;
            padding: 0.3rem;
            margin: 0.3rem 0 0.2rem 0;
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            color: #00ff00;
            text-shadow: 0 0 5px #00ff00;
            display: flex;
            align-items: center;
            justify-content: center;
            letter-spacing: 1px;
        }
        .display-screen.off {
            color: #f00;
            text-shadow: 0 0 5px #f00;
        }
        
        @media (max-width: 768px) {
            .palco-container {
                padding: 10px;
            }
            
            .status-grid {
                grid-template-columns: 1fr;
            }
            
            .buttons-card {
                flex-direction: row;
                width: 100%;
                min-width: 0;
                padding: 0.3rem 0.2rem;
            }
            
            .action-btn {
                width: 36px;
                height: 36px;
                font-size: 1.1rem;
            }
            
            .palco-title {
                font-size: 2rem;
            }
            
            .bank-name {
                font-size: 2.5rem;
            }
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.3rem 0;
            border-bottom: 1px solid #333;
            font-size: 0.8rem;
        }
        
        .info-label {
            font-weight: bold;
            color: #ccc;
        }
        
        .info-value {
            color: #ffb300;
            font-weight: bold;
        }
        
        .reconnect-btn { 
            margin-top: 0.8rem; 
            background: #ff6b35; 
            color: #fff; 
            border: none; 
            border-radius: 0.3rem; 
            padding: 0.5rem 1rem; 
            font-size: 0.8rem; 
            font-weight: bold; 
            cursor: pointer; 
            transition: background 0.2s;
            width: 100%;
        }
        
        .reconnect-btn:hover { 
            background: #e55a2b; 
        }
        
        .reconnect-btn:disabled { 
            background: #666; 
            cursor: not-allowed; 
        }
        
        .midi-status {
            background: #2a2e3a;
            border-radius: 0.5rem;
            padding: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.7rem;
            text-align: center;
            color: #ccc;
        }
        
        .midi-status.active {
            background: #1a3a1a;
            color: #0f0;
            border: 1px solid #0f0;
        }
        
        .chocolate-pedal-visual {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            gap: 0.5rem;
        }
        
        .chocolate-display-wrapper {
            /* Remover estilos visuais, deixar vazio ou remover a classe se não for usada em outro lugar */
        }
        
        .chocolate-leds {
            width: 110px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 3rem;
            margin: 0;
            padding: 0;
        }
        
        .chocolate-led {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #555;
            background: #333;
            transition: all 0.3s ease;
        }
        
        .chocolate-led.on {
            background: #0f0;
            box-shadow: 0 0 15px #0f0;
            border-color: #0f0;
        }
        
        .chocolate-led.off {
            background: #333;
            border-color: #555;
        }
        
        .chocolate-display {
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            font-weight: bold;
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
            text-align: center;
        }
        
        .chocolate-display.off {
            color: #f00;
            text-shadow: 0 0 5px #f00;
        }
        
        .chocolate-connect-btn {
            background: #2a5a2a;
            color: #fff;
            border: none;
            border-radius: 0.3rem;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 0.5rem;
            width: 100%;
        }
        
        .chocolate-connect-btn:hover {
            background: #3a7a3a;
        }
        
        .chocolate-connect-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .zoom-display-wrapper {
            background: #000;
            border: 2px solid #333;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            margin: 0 1rem;
            min-width: 80px;
            min-height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .zoom-display {
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            font-weight: bold;
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
        }
        
        .zoom-effect {
            width: 10px;
            height: 18px;
            border-radius: 2px;
            border: 1px solid #ffd700;
            background: #ffd700;
            box-shadow: 0 0 8px #ffd700;
            transition: all 0.3s ease;
        }
        
        .zoom-effect.off {
            background: #333;
            border-color: #555;
            box-shadow: none;
        }
        
        .zoom-display.off {
            color: #f00;
            text-shadow: 0 0 5px #f00;
        }
    </style>
</head>
<body>
    <div class="palco-container">
        <div class="palco-header">
            <div class="bank-name" id="bank-name">Aguardando Comando</div>
        </div>
        
        <div class="status-grid" id="status-grid">
            <!-- Status dos dispositivos será renderizado aqui dinamicamente -->
            <!-- Caixa de botões será adicionada aqui dinamicamente -->
        </div>
    </div>
    
    <script>
        let activePatch = null;
        let activeBank = null;
        let midiMonitoringActive = false;
        let lastActiveBankId = null; // Para controlar mudanças no banco ativo
        let isInitialLoad = true; // Para controlar o carregamento inicial
        
        async function loadPalcoInfo() {
            try {
                // Carrega informações do banco ativo
                const bankChanged = await loadActiveBankInfo();
                
                // Na primeira execução ou se o banco ativo mudou, carrega tudo
                if (isInitialLoad || bankChanged) {
                    console.log(isInitialLoad ? '🚀 Carregamento inicial...' : '🔄 Banco ativo mudou, recarregando informações...');
                    
                    // Carrega informações do patch ativo
                    await loadActivePatchInfo();
                    
                    // Carrega dispositivos (sempre na primeira execução)
                    await loadDevicesInfo();
                    
                    // Inicia monitoramento MIDI se não estiver ativo
                    if (!midiMonitoringActive) {
                        await startMidiMonitoring();
                    }
                    
                    // Marca que não é mais o carregamento inicial
                    isInitialLoad = false;
                } else {
                    // Se o banco não mudou, só atualiza o patch ativo (pode ter mudado por MIDI)
                    await loadActivePatchInfo();
                }
                
            } catch (error) {
                console.error('Erro ao carregar informações do palco:', error);
            }
        }
        
        async function loadActiveBankInfo() {
            try {
                const response = await fetch('/api/midi/banks/active');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const newBank = data.data;
                    const newBankId = newBank.id;
                    
                    // Verifica se o banco ativo mudou
                    if (lastActiveBankId !== newBankId) {
                        console.log(`🔄 Banco ativo mudou: ${lastActiveBankId} -> ${newBankId}`);
                        activeBank = newBank;
                        lastActiveBankId = newBankId;
                        showActiveBank(activeBank);
                        return true; // Indica que o banco mudou
                    } else {
                        // Banco não mudou
                        return false;
                    }
                } else {
                    // Se não há banco ativo
                    if (lastActiveBankId !== null) {
                        console.log('🔄 Banco ativo removido');
                        lastActiveBankId = null;
                        hideActiveBank();
                        return true; // Indica mudança (banco foi removido)
                    } else {
                        hideActiveBank();
                        return false; // Não mudou
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar banco ativo:', error);
                hideActiveBank();
                return false;
            }
        }
        
        function showActiveBank(bank) {
            document.getElementById('bank-name').textContent = bank.name;
        }
        
        function hideActiveBank() {
            document.getElementById('bank-name').textContent = 'Aguardando Comando';
        }
        
        async function loadActivePatchInfo() {
            try {
                const response = await fetch('/api/patches/active');
                const data = await response.json();
                
                if (data.success && data.data && data.data.active_patch) {
                    activePatch = data.data.active_patch;
                    
                    // Mostra o nome do patch ativo no título
                    document.getElementById('bank-name').textContent = activePatch.name;
                    
                    // Atualiza o visual do Chocolate se o patch ativo for do Chocolate
                    if (activePatch.input_device === 'Chocolate MIDI In' && activePatch.input_channel !== undefined) {
                        const bankNumber = parseInt(activePatch.input_channel);
                        // Busca o status de conexão do Chocolate
                        const devicesResponse = await fetch('/api/midi/devices/status_detailed');
                        const devicesData = await devicesResponse.json();
                        if (devicesData.success) {
                            const chocolateDevice = devicesData.data.find(dev => dev.type === 'chocolate');
                            if (chocolateDevice) {
                                renderChocolatePedal(bankNumber, chocolateDevice.connected);
                            }
                        }
                    }
                    
                    // Atualiza o display do Zoom se o patch tiver configuração da Zoom
                    if (activePatch.zoom_bank !== undefined && activePatch.zoom_patch !== undefined) {
                        // Busca o status de conexão da Zoom
                        const devicesResponse = await fetch('/api/midi/devices/status_detailed');
                        const devicesData = await devicesResponse.json();
                        if (devicesData.success) {
                            const zoomDevice = devicesData.data.find(dev => dev.type === 'zoom_g3x');
                            if (zoomDevice) {
                                // Usa zoom_bank_letter se disponível, senão zoom_bank
                                const bankToShow = activePatch.zoom_bank_letter || activePatch.zoom_bank;
                                updateZoomDisplay(bankToShow, activePatch.zoom_patch, zoomDevice.connected);
                            }
                        }
                    }
                } else {
                    // Se não há patch ativo, mostra "Aguardando Comando"
                    document.getElementById('bank-name').textContent = 'Aguardando Comando';
                }
            } catch (error) {
                document.getElementById('bank-name').textContent = 'Aguardando Comando';
            }
        }
        
        function hideActivePatch() {
            // Mostra a mensagem no título
            document.getElementById('bank-name').textContent = 'Não existe patch para este banco';
        }
        
        async function loadDevicesInfo() {
            try {
                const response = await fetch('/api/midi/devices/status_detailed');
                const data = await response.json();
                const grid = document.getElementById('status-grid');
                grid.innerHTML = '';
                if (data.success && Array.isArray(data.data)) {
                    // Filtra apenas o primeiro Zoom G3X e o primeiro Chocolate MIDI
                    const zoom = data.data.find(dev => dev.type === 'zoom_g3x');
                    const chocolate = data.data.find(dev => dev.type === 'chocolate');
                    if (zoom) grid.appendChild(createDeviceBox(zoom));
                    if (chocolate) grid.appendChild(createChocolatePedalBox(chocolate));
                }
                // Adiciona a caixa de botões
                const buttonsBox = createButtonsBox();
                grid.appendChild(buttonsBox);
            } catch (error) {
                console.error('Erro ao carregar dispositivos:', error);
            }
        }
        
        function createButtonsBox() {
            const box = document.createElement('div');
            box.className = 'device-box buttons-card';
            box.innerHTML = `
                <button class="action-btn back-btn" title="Voltar" onclick="window.location.href='/'">←</button>
                <button class="action-btn refresh-btn" title="Atualizar" onclick="window.location.reload()">🔄</button>
                <button class="action-btn edit-btn" title="Edição" onclick="window.location.href='/edicao'">✏️</button>
                <button class="action-btn fullscreen-btn" id="fullscreen-btn" title="Tela cheia" onclick="toggleFullscreen()">⛶</button>
            `;
            return box;
        }
        
        function createDeviceBox(dev) {
            // Apenas Zoom G3X
            const box = document.createElement('div');
            box.className = 'device-box';
            const connectionClass = dev.connected ? 'connected' : 'disconnected';
            let displayText = '---';
            if (dev.connected && dev.bank !== undefined && dev.last_pc !== undefined) {
                const bankLetter = String.fromCharCode(65 + parseInt(dev.bank));
                displayText = `${bankLetter}-${dev.last_pc}`;
            }
            box.innerHTML = `
                <div class="device-header">
                    <span class="connection-icon ${connectionClass}"></span>
                    <span class="device-title">Zoom G3X</span>
                </div>
                <div class="display-screen zoom-display-text" id="zoom-display-text">${displayText}</div>
                <div class="zoom-effects">
                    <div class="zoom-effect" id="zoom-effect-1"></div>
                    <div class="zoom-effect" id="zoom-effect-2"></div>
                    <div class="zoom-effect" id="zoom-effect-3"></div>
                    <div class="zoom-effect" id="zoom-effect-4"></div>
                    <div class="zoom-effect" id="zoom-effect-5"></div>
                    <div class="zoom-effect" id="zoom-effect-6"></div>
                </div>
            `;
            return box;
        }
        
        function createChocolatePedalBox(dev) {
            const box = document.createElement('div');
            box.className = 'device-box';
            const connectionClass = dev.connected ? 'connected' : 'disconnected';
            let currentBank = 0;
            if (activePatch && activePatch.input_device === 'Chocolate MIDI In' && activePatch.input_channel !== undefined) {
                currentBank = parseInt(activePatch.input_channel);
            }
            renderChocolatePedal(currentBank, dev.connected);
            const connectButton = dev.connected ? '' : `
                <button class="chocolate-connect-btn" onclick="connectChocolate()">
                    🔌 Conectar Chocolate MIDI
                </button>
            `;
            box.innerHTML = `
                <div class="device-header">
                    <span class="connection-icon ${connectionClass}" id="chocolate-connection-icon"></span>
                    <span class="device-title">Chocolate MIDI</span>
                </div>
                <div class="display-screen chocolate-display" id="chocolate-display">000</div>
                <div class="pedal-leds">
                    <div class="led" id="led-0"></div>
                    <div class="led" id="led-1"></div>
                    <div class="led" id="led-2"></div>
                    <div class="led" id="led-3"></div>
                </div>
                ${connectButton}
            `;
            return box;
        }
        
        function renderChocolatePedal(bankNumber, connected) {
            updateChocolateDisplay(bankNumber);
            const icon = document.getElementById('chocolate-connection-icon');
            if (icon) {
                icon.classList.toggle('connected', connected);
                icon.classList.toggle('disconnected', !connected);
            }
        }
        
        function updateZoomDisplay(bank, patch, connected) {
            const display = document.getElementById('zoom-display-text');
            if (display) {
                let displayText = '---';
                if (connected && bank !== '-' && patch !== '-') {
                    let bankLetter = bank;
                    if (typeof bank === 'number' || (typeof bank === 'string' && !isNaN(bank))) {
                        bankLetter = String.fromCharCode(65 + parseInt(bank));
                    }
                    displayText = `${bankLetter}-${patch}`;
                }
                display.textContent = displayText;
                display.classList.toggle('off', !connected);
            }
            for (let i = 1; i <= 6; i++) {
                const effect = document.getElementById(`zoom-effect-${i}`);
                if (effect) {
                    effect.classList.remove('off'); // Sempre ligados por padrão
                }
            }
        }
        
        async function startMidiMonitoring() {
            try {
                const response = await fetch('/api/midi/monitor/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        device: 'Chocolate MIDI In'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    midiMonitoringActive = true;
                    // Inicia polling para verificar comandos MIDI
                    startMidiPolling();
                }
                
            } catch (error) {
                // Erro silencioso
            }
        }
        
        function startMidiPolling() {
            // Verifica comandos MIDI a cada 500ms
            setInterval(async () => {
                if (!midiMonitoringActive) return;
                
                try {
                    const response = await fetch('/api/midi/commands/received');
                    const data = await response.json();
                    
                    if (data.success && data.commands && data.commands.length > 0) {
                        // Processa novos comandos MIDI
                        data.commands.forEach(command => {
                            processMidiCommand(command);
                        });
                    }
                } catch (error) {
                    console.error('Erro ao verificar comandos MIDI:', error);
                }
            }, 500);
        }
        
        function processMidiCommand(command) {
            // Se for um Program Change do Chocolate, busca e ativa o patch correspondente
            if (command.type === 'program_change' && command.program !== undefined) {
                // SEMPRE atualiza o display do Chocolate com o banco selecionado
                updateChocolateDisplay(command.program);
                
                // Busca e ativa o patch correspondente
                findAndActivatePatchByProgram(command.program);
            }
        }
        
        function updateChocolateDisplay(program) {
            // Atualiza o display do Chocolate para mostrar o banco selecionado
            const display = document.getElementById('chocolate-display');
            if (display) {
                display.textContent = ('' + program).padStart(3, '0');
                display.classList.remove('off');
            }
            
            // Atualiza os LEDs do Chocolate
            const ledIndex = program % 4;
            for (let i = 0; i < 4; i++) {
                const led = document.getElementById('led-' + i);
                if (led) {
                    if (i === ledIndex) {
                        led.classList.add('on');
                        led.classList.remove('off');
                    } else {
                        led.classList.remove('on');
                        led.classList.add('off');
                    }
                }
            }
        }
        
        async function findAndActivatePatchByProgram(program) {
            try {
                console.log('🎹 ===== INÍCIO BUSCA PATCH POR PROGRAM =====');
                console.log(`🔍 Procurando patch com program ${program}...`);
                
                // 1. Primeiro, vamos buscar a configuração MIDI do sistema para saber qual é o dispositivo de entrada
                console.log('🎹 Buscando configuração MIDI do sistema...');
                const configResponse = await fetch('/api/midi/config');
                const configData = await configResponse.json();
                console.log('🎹 Configuração MIDI do sistema:', JSON.stringify(configData, null, 2));
                
                if (!configData.success || !configData.data) {
                    console.log('❌ Erro ao buscar configuração MIDI do sistema');
                    return;
                }
                
                const inputDevice = configData.data.input_device;
                console.log(`🎹 Dispositivo de entrada configurado: "${inputDevice}"`);
                
                // 2. Agora vamos buscar todos os patches
                console.log('🎹 Buscando patches na API...');
                const response = await fetch('/api/patches');
                const data = await response.json();
                
                if (data.success && data.data) {
                    console.log(`📋 Total de patches encontrados: ${data.data.length}`);
                    
                    // 3. Filtrar patches que usam o dispositivo de entrada configurado
                    const inputPatches = data.data.filter(patch => patch.input_device === inputDevice);
                    console.log(`🎹 Patches que usam "${inputDevice}" como entrada: ${inputPatches.length}`);
                    
                    // 4. Buscar patch com o input_channel específico (canal MIDI do Chocolate)
                    const matchingPatches = inputPatches.filter(patch => patch.input_channel === program);
                    console.log(`🎯 Patches com input_channel ${program}: ${matchingPatches.length}`);
                    
                    if (matchingPatches.length > 0) {
                        const patch = matchingPatches[0];
                        console.log(`✅ Patch encontrado: ${patch.name}`);
                        console.log('✅ Dados completos do patch:', JSON.stringify(patch, null, 2));
                        
                        // Ativa o patch no sistema
                        console.log('🎹 Chamando activatePatch...');
                        await activatePatch(patch);
                    } else {
                        // Nenhum patch encontrado para esse program
                        console.log('❌ Nenhum patch encontrado para program', program);
                        document.getElementById('bank-name').textContent = 'Sem banco cadastrado.';
                        // Limpa o display da Zoom
                        updateZoomDisplay('-', '-', false);
                    }
                } else {
                    console.log(`❌ Erro na resposta da API de patches`);
                    console.log('❌ Resposta completa:', JSON.stringify(data, null, 2));
                }
                
                console.log('🎹 ===== FIM BUSCA PATCH POR PROGRAM =====');
            } catch (error) {
                console.error('❌ Erro ao procurar patch por program:', error);
                console.error('❌ Stack trace:', error.stack);
                // Mostra a mensagem no título em caso de erro
                document.getElementById('bank-name').textContent = 'Aguardando Comando';
                
                // Limpa o display da Zoom em caso de erro
                updateZoomDisplay('-', '-', false);
                console.log('🎹 ===== FIM BUSCA PATCH POR PROGRAM (COM ERRO) =====');
            }
        }
        
        async function activatePatch(patch) {
            try {
                console.log('🎹 ===== INÍCIO ATIVAÇÃO PATCH =====');
                console.log(`🎹 Patch a ser ativado: ${patch.name}`);
                console.log('🎹 Dados completos do patch:', JSON.stringify(patch, null, 2));
                
                // Log do payload que será enviado
                const payload = { patch_id: patch.id };
                console.log('🎹 Payload enviado para /api/midi/patch/load:', JSON.stringify(payload, null, 2));
                
                // Ativa o patch via API
                console.log('🎹 Enviando requisição POST para /api/midi/patch/load...');
                const response = await fetch('/api/midi/patch/load', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                console.log('🎹 Status da resposta:', response.status);
                console.log('🎹 Headers da resposta:', Object.fromEntries(response.headers.entries()));
                
                const data = await response.json();
                console.log('🎹 Resposta completa da API:', JSON.stringify(data, null, 2));
                
                if (data.success) {
                    console.log('✅ Patch ativado no sistema com sucesso');
                    console.log('✅ Dados retornados pela API:', JSON.stringify(data.data, null, 2));
                    activePatch = patch;
                    
                    // Mostra o nome do patch ativo no título
                    document.getElementById('bank-name').textContent = patch.name;
                    
                    // Atualiza o visual do Chocolate se o patch for do Chocolate
                    if (patch.input_device === 'Chocolate MIDI In' && patch.input_channel !== undefined) {
                        console.log('🎹 Patch é do Chocolate, atualizando visual...');
                        const bankNumber = parseInt(patch.input_channel);
                        console.log('🎹 Número do banco do Chocolate:', bankNumber);
                        
                        // Busca o status de conexão do Chocolate
                        console.log('🎹 Buscando status dos dispositivos...');
                        const devicesResponse = await fetch('/api/midi/devices/status_detailed');
                        const devicesData = await devicesResponse.json();
                        console.log('🎹 Status dos dispositivos:', JSON.stringify(devicesData, null, 2));
                        
                        if (devicesData.success) {
                            const chocolateDevice = devicesData.data.find(dev => dev.type === 'chocolate');
                            if (chocolateDevice) {
                                console.log('🎹 Dispositivo Chocolate encontrado:', JSON.stringify(chocolateDevice, null, 2));
                                renderChocolatePedal(bankNumber, chocolateDevice.connected);
                            } else {
                                console.log('❌ Dispositivo Chocolate não encontrado na lista');
                            }
                        }
                    }
                    
                    // Atualiza o display do Zoom se o patch tiver configuração da Zoom
                    console.log('🎹 Verificando configuração da Zoom...');
                    console.log('🎹 zoom_bank:', patch.zoom_bank);
                    console.log('🎹 zoom_patch:', patch.zoom_patch);
                    console.log('🎹 zoom_bank_letter:', patch.zoom_bank_letter);
                    
                    if (patch.zoom_bank !== undefined && patch.zoom_patch !== undefined) {
                        console.log('🎹 Patch tem configuração da Zoom, atualizando display...');
                        // Busca o status de conexão da Zoom
                        const devicesResponse = await fetch('/api/midi/devices/status_detailed');
                        const devicesData = await devicesResponse.json();
                        if (devicesData.success) {
                            const zoomDevice = devicesData.data.find(dev => dev.type === 'zoom_g3x');
                            if (zoomDevice) {
                                console.log('🎹 Dispositivo Zoom encontrado:', JSON.stringify(zoomDevice, null, 2));
                                // Usa zoom_bank_letter se disponível, senão zoom_bank
                                const bankToShow = patch.zoom_bank_letter || patch.zoom_bank;
                                console.log('🎹 Banco a mostrar no display Zoom:', bankToShow);
                                console.log('🎹 Patch global da Zoom:', patch.zoom_patch);
                                
                                // Converte o número global para local (0-9 dentro do banco)
                                let localPatchNumber = patch.zoom_patch;
                                if (patch.zoom_patch !== undefined && patch.zoom_patch !== null) {
                                    // Converte número global para local (0-9)
                                    localPatchNumber = patch.zoom_patch % 10;
                                }
                                console.log('🎹 Patch local a mostrar no display Zoom:', localPatchNumber);
                                updateZoomDisplay(bankToShow, localPatchNumber, zoomDevice.connected);
                            } else {
                                console.log('❌ Dispositivo Zoom não encontrado na lista');
                            }
                        }
                    } else {
                        console.log('❌ Patch não tem configuração da Zoom (zoom_bank ou zoom_patch undefined)');
                    }
                } else {
                    console.error('❌ Erro ao ativar patch:', data.error);
                    console.error('❌ Resposta completa de erro:', JSON.stringify(data, null, 2));
                }
                
                console.log('🎹 ===== FIM ATIVAÇÃO PATCH =====');
            } catch (error) {
                console.error('❌ Erro ao ativar patch:', error);
                console.error('❌ Stack trace:', error.stack);
                console.log('🎹 ===== FIM ATIVAÇÃO PATCH (COM ERRO) =====');
            }
        }
        
        // Função para reconectar Zoom G3X
        async function reconnectZoomG3X() {
            try {
                const response = await fetch('/api/midi/devices/zoom_g3x/reconnect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('Zoom G3X reconectado com sucesso!');
                    loadPalcoInfo(); // Recarrega as informações
                } else {
                    console.error('Erro ao reconectar Zoom G3X:', data.message || 'Erro desconhecido');
                }
            } catch (error) {
                console.error('Erro ao reconectar Zoom G3X:', error.message);
            }
        }
        
        // Função para reconectar Chocolate
        async function reconnectChocolate() {
            try {
                const response = await fetch('/api/midi/devices/chocolate/reconnect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('Chocolate reconectado com sucesso!');
                    loadPalcoInfo(); // Recarrega as informações
                } else {
                    console.error('Erro ao reconectar Chocolate:', data.message || 'Erro desconhecido');
                }
            } catch (error) {
                console.error('Erro ao reconectar Chocolate:', error.message);
            }
        }
        
        async function connectChocolate() {
            try {
                console.log('🔌 Conectando Chocolate MIDI...');
                
                const response = await fetch('/api/midi/devices/chocolate/reconnect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('✅ Chocolate MIDI conectado');
                    
                    // Recarrega informações dos dispositivos
                    await loadDevicesInfo();
                    
                    // Inicia monitoramento MIDI se não estiver ativo
                    if (!midiMonitoringActive) {
                        await startMidiMonitoring();
                    }
                } else {
                    console.error('❌ Erro ao conectar Chocolate MIDI:', data.error);
                }
                
            } catch (error) {
                console.error('❌ Erro ao conectar Chocolate MIDI:', error);
            }
        }

        function toggleFullscreen() {
            const btn = document.getElementById('fullscreen-btn');
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
                if (btn) btn.textContent = '🗗';
                if (btn) btn.title = 'Sair do modo tela cheia';
            } else {
                document.exitFullscreen();
                if (btn) btn.textContent = '⛶';
                if (btn) btn.title = 'Entrar no modo tela cheia';
            }
        }

        document.addEventListener('fullscreenchange', () => {
            const btn = document.getElementById('fullscreen-btn');
            if (!btn) return;
            if (document.fullscreenElement) {
                btn.textContent = '🗗';
                btn.title = 'Sair do modo tela cheia';
            } else {
                btn.textContent = '⛶';
                btn.title = 'Entrar no modo tela cheia';
            }
        });

        // Inicialização simplificada
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('🚀 Carregamento inicial do palco...');
                
                // Carrega dispositivos uma vez só
                await loadDevicesInfo();
                
                // Inicia monitoramento MIDI
                await startMidiMonitoring();
                
                // Carrega patch ativo se houver
                await loadActivePatchInfo();
                
                console.log('✅ Palco inicializado');
            } catch (error) {
                console.error('Erro na inicialização do palco:', error);
            }
        });
    </script>
</body>
</html> 