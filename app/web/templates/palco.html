<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RaspMIDI - Palco</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        body { 
            background: #181c24; 
            color: #fff; 
            font-family: 'Segoe UI', Arial, sans-serif; 
            margin: 0;
            padding: 0;
            font-size: 14px;
        }
        
        .palco-container { 
            max-width: 100%; 
            margin: 0 auto; 
            padding: 10px; 
            position: relative;
        }
        
        .back-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #2d8cff;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            z-index: 100;
        }
        
        .back-btn:hover { 
            background: #1a5fb4; 
            transform: scale(1.1);
        }
        
        .active-bank-info {
            background: #23283a;
            border-radius: 0.8rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
            border: 2px solid #ffb300;
        }
        
        .active-bank-name {
            font-size: 1.8rem;
            font-weight: bold;
            color: #ffb300;
            margin-bottom: 0.5rem;
        }
        
        .active-bank-description {
            font-size: 0.9rem;
            color: #ccc;
        }
        
        .active-patch-info {
            background: #1a1e2a;
            border-radius: 0.8rem;
            padding: 1rem;
            margin-bottom: 1rem;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            border: 1px solid #333;
        }
        
        .active-patch-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #0f0;
            margin-bottom: 0.5rem;
        }
        
        .active-patch-details {
            font-size: 0.8rem;
            color: #ccc;
        }
        
        .no-active-patch {
            text-align: center;
            color: #888;
            font-style: italic;
            padding: 1rem;
            font-size: 0.9rem;
        }
        
        .devices-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .device-box { 
            background: #1a1e2a; 
            border-radius: 0.8rem; 
            padding: 1rem; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            border: 1px solid #333;
            transition: all 0.3s;
        }
        
        .device-box:hover {
            border-color: #ffb300;
        }
        
        .device-header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.8rem;
            gap: 0.5rem;
        }
        
        .device-title { 
            font-size: 1.1rem; 
            font-weight: bold; 
            color: #ffb300;
        }
        
        .connection-icon {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid;
        }
        
        .connection-icon.connected {
            background: #0f0;
            border-color: #0f0;
        }
        
        .connection-icon.disconnected {
            background: #f33;
            border-color: #f33;
        }
        
        .device-info {
            margin-bottom: 0.8rem;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.3rem 0;
            border-bottom: 1px solid #333;
            font-size: 0.8rem;
        }
        
        .info-label {
            font-weight: bold;
            color: #ccc;
        }
        
        .info-value {
            color: #ffb300;
            font-weight: bold;
        }
        
        .reconnect-btn { 
            margin-top: 0.8rem; 
            background: #ff6b35; 
            color: #fff; 
            border: none; 
            border-radius: 0.3rem; 
            padding: 0.5rem 1rem; 
            font-size: 0.8rem; 
            font-weight: bold; 
            cursor: pointer; 
            transition: background 0.2s;
            width: 100%;
        }
        
        .reconnect-btn:hover { 
            background: #e55a2b; 
        }
        
        .reconnect-btn:disabled { 
            background: #666; 
            cursor: not-allowed; 
        }
        
        .chocolate-patches {
            margin-top: 0.8rem;
        }
        
        .patch-item {
            background: #333;
            border: 1px solid #555;
            border-radius: 0.3rem;
            padding: 0.5rem;
            margin-bottom: 0.3rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .patch-item:hover {
            background: #555;
            border-color: #ffb300;
        }
        
        .patch-item.active {
            background: #ffb300;
            color: #000;
            border-color: #ffb300;
        }
        
        .patch-name {
            font-weight: bold;
            margin-bottom: 0.2rem;
        }
        
        .patch-details {
            font-size: 0.7rem;
            color: #ccc;
        }
        
        .patch-item.active .patch-details {
            color: #333;
        }
    </style>
</head>
<body>
    <div class="palco-container">
        <button class="back-btn" onclick="window.location.href='/'">←</button>
        
        <div class="active-bank-info" id="active-bank-info">
            <div class="active-bank-name" id="active-bank-name">Nenhum Banco Ativo</div>
            <div class="active-bank-description" id="active-bank-description">Configure um banco ativo</div>
        </div>
        
        <div class="active-patch-info" id="active-patch-info">
            <div class="no-active-patch" id="no-active-patch">
                Nenhum patch ativo - Selecione um patch no Chocolate MIDI
            </div>
            <div id="active-patch-content" style="display: none;">
                <div class="active-patch-name" id="active-patch-name">-</div>
                <div class="active-patch-details" id="active-patch-details">-</div>
            </div>
        </div>
        
        <div class="devices-grid" id="devices-grid">
            <!-- Dispositivos serão renderizados aqui -->
        </div>
    </div>
    
    <script>
        let activePatch = null;
        let activeBank = null;
        let chocolatePatches = [];
        
        async function loadPalcoInfo() {
            try {
                // Carrega informações do banco ativo
                await loadActiveBankInfo();
                
                // Carrega informações do patch ativo
                await loadActivePatchInfo();
                
                // Carrega dispositivos
                await loadDevicesInfo();
                
                // Carrega patches do Chocolate MIDI
                await loadChocolatePatches();
                
            } catch (error) {
                console.error('Erro ao carregar informações do palco:', error);
            }
        }
        
        async function loadActiveBankInfo() {
            try {
                const response = await fetch('/api/midi/banks/active');
                const data = await response.json();
                
                if (data.success && data.data) {
                    activeBank = data.data;
                    showActiveBank(activeBank);
                } else {
                    hideActiveBank();
                }
            } catch (error) {
                console.error('Erro ao carregar banco ativo:', error);
                hideActiveBank();
            }
        }
        
        function showActiveBank(bank) {
            document.getElementById('active-bank-name').textContent = bank.name;
            document.getElementById('active-bank-description').textContent = bank.description || 'Banco ativo';
        }
        
        function hideActiveBank() {
            document.getElementById('active-bank-name').textContent = 'Nenhum Banco Ativo';
            document.getElementById('active-bank-description').textContent = 'Configure um banco ativo';
        }
        
        async function loadActivePatchInfo() {
            try {
                const response = await fetch('/api/patches/active');
                const data = await response.json();
                
                if (data.success && data.data && data.data.active_patch) {
                    activePatch = data.data.active_patch;
                    showActivePatch(activePatch);
                } else {
                    hideActivePatch();
                }
            } catch (error) {
                console.error('Erro ao carregar patch ativo:', error);
                hideActivePatch();
            }
        }
        
        function showActivePatch(patch) {
            document.getElementById('no-active-patch').style.display = 'none';
            document.getElementById('active-patch-content').style.display = 'block';
            
            document.getElementById('active-patch-name').textContent = patch.name;
            
            const details = [];
            if (patch.input_device) details.push(`Entrada: ${patch.input_device}`);
            if (patch.output_device) details.push(`Saída: ${patch.output_device}`);
            if (patch.command_type) details.push(`Comando: ${patch.command_type.toUpperCase()}`);
            
            document.getElementById('active-patch-details').textContent = details.join(' • ');
        }
        
        function hideActivePatch() {
            document.getElementById('no-active-patch').style.display = 'block';
            document.getElementById('active-patch-content').style.display = 'none';
        }
        
        async function loadDevicesInfo() {
            try {
                const response = await fetch('/api/midi/devices/status_detailed');
                const data = await response.json();
                
                const grid = document.getElementById('devices-grid');
                grid.innerHTML = '';
                
                if (data.success && Array.isArray(data.data)) {
                    data.data.forEach(dev => {
                        const box = createDeviceBox(dev);
                        grid.appendChild(box);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar dispositivos:', error);
            }
        }
        
        function createDeviceBox(dev) {
            const box = document.createElement('div');
            box.className = 'device-box';
            
            const connectionClass = dev.connected ? 'connected' : 'disconnected';
            
            let deviceInfo = '';
            let reconnectBtn = '';
            
            if (dev.type === 'zoom_g3x') {
                // Para Zoom G3X: mostra banco e patch atual
                const bank = dev.bank || '-';
                const patch = dev.last_pc !== null && dev.last_pc !== undefined ? dev.last_pc : '-';
                deviceInfo = `
                    <div class="device-info">
                        <div class="info-row">
                            <span class="info-label">Banco:</span>
                            <span class="info-value">${bank}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Patch:</span>
                            <span class="info-value">${patch}</span>
                        </div>
                    </div>
                `;
            } else if (dev.type === 'chocolate') {
                // Para Chocolate: mostra patches disponíveis
                deviceInfo = `
                    <div class="device-info">
                        <div class="info-row">
                            <span class="info-label">Patches:</span>
                            <span class="info-value">${chocolatePatches.length}</span>
                        </div>
                    </div>
                    <div class="chocolate-patches" id="chocolate-patches">
                        <!-- Patches serão renderizados aqui -->
                    </div>
                `;
            }
            
            if (!dev.connected) {
                if (dev.type === 'zoom_g3x') {
                    reconnectBtn = `<button class="reconnect-btn" onclick="reconnectZoomG3X()">Reconectar Zoom G3X</button>`;
                } else if (dev.type === 'chocolate') {
                    reconnectBtn = `<button class="reconnect-btn" onclick="reconnectChocolate()">Reconectar Chocolate</button>`;
                }
            }
            
            box.innerHTML = `
                <div class="device-header">
                    <div class="connection-icon ${connectionClass}"></div>
                    <div class="device-title">${dev.name}</div>
                </div>
                ${deviceInfo}
                ${reconnectBtn}
            `;
            
            return box;
        }
        
        async function loadChocolatePatches() {
            try {
                // Busca todos os patches do Chocolate MIDI
                const response = await fetch('/api/patches');
                const data = await response.json();
                
                if (data.success && data.data) {
                    chocolatePatches = data.data.filter(patch => 
                        patch.input_device === 'Chocolate MIDI'
                    );
                    renderChocolatePatches();
                }
            } catch (error) {
                console.error('Erro ao carregar patches do Chocolate:', error);
            }
        }
        
        function renderChocolatePatches() {
            const container = document.getElementById('chocolate-patches');
            if (!container) return;
            
            container.innerHTML = '';
            
            chocolatePatches.forEach(patch => {
                const patchElement = document.createElement('div');
                patchElement.className = 'patch-item';
                
                if (activePatch && activePatch.id === patch.id) {
                    patchElement.classList.add('active');
                }
                
                const details = [];
                if (patch.input_channel) details.push(`Canal ${patch.input_channel}`);
                if (patch.command_type) details.push(patch.command_type.toUpperCase());
                if (patch.program !== null) details.push(`Prog ${patch.program}`);
                
                patchElement.innerHTML = `
                    <div class="patch-name">${patch.name}</div>
                    <div class="patch-details">${details.join(' • ')}</div>
                `;
                
                patchElement.onclick = () => selectChocolatePatch(patch);
                
                container.appendChild(patchElement);
            });
        }
        
        async function selectChocolatePatch(patch) {
            try {
                console.log(`🎹 Selecionando patch do Chocolate: ${patch.name}`);
                
                // Ativa o patch via API
                const response = await fetch('/api/midi/patch/load', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ patch_id: patch.id })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    activePatch = patch;
                    showActivePatch(patch);
                    renderChocolatePatches(); // Atualiza visual dos patches
                    
                    // Recarrega informações dos dispositivos para mostrar mudanças
                    setTimeout(loadDevicesInfo, 1000);
                    
                    console.log(`✅ Patch ${patch.name} ativado com sucesso`);
                } else {
                    console.error('❌ Erro ao ativar patch:', data.error);
                    alert('Erro ao ativar patch: ' + (data.error || 'Erro desconhecido'));
                }
                
            } catch (error) {
                console.error('❌ Erro ao selecionar patch:', error);
                alert('Erro ao selecionar patch: ' + error.message);
            }
        }
        
        // Função para reconectar Zoom G3X
        async function reconnectZoomG3X() {
            try {
                const response = await fetch('/api/midi/devices/zoom_g3x/reconnect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Zoom G3X reconectado com sucesso!');
                    loadPalcoInfo(); // Recarrega as informações
                } else {
                    alert('Erro ao reconectar Zoom G3X: ' + (data.message || 'Erro desconhecido'));
                }
            } catch (error) {
                alert('Erro ao reconectar Zoom G3X: ' + error.message);
            }
        }
        
        // Função para reconectar Chocolate
        async function reconnectChocolate() {
            try {
                const response = await fetch('/api/midi/devices/chocolate/reconnect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Chocolate reconectado com sucesso!');
                    loadPalcoInfo(); // Recarrega as informações
                } else {
                    alert('Erro ao reconectar Chocolate: ' + (data.message || 'Erro desconhecido'));
                }
            } catch (error) {
                alert('Erro ao reconectar Chocolate: ' + error.message);
            }
        }

        // Inicialização
        window.addEventListener('DOMContentLoaded', loadPalcoInfo);
        
        // Atualiza a cada 2 segundos para responder rapidamente
        setInterval(loadPalcoInfo, 2000);
    </script>
</body>
</html> 